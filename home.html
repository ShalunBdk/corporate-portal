<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://yastatic.net/s3/passport-sdk/autofill/v1/sdk-suggest-token-with-polyfills-latest.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="static/itc-slider.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="static/itc-slider.js" defer></script>
    <title>Корпоративный портал</title>
    <style>
        .iframe-container {
            flex: 1;
            overflow: hidden;     
            box-sizing: border-box;
        }
        iframe {
            width: 80vw;
            height: 80vh;
            border: none;
            box-sizing: border-box;
        }
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Скрыть iframe до загрузки */
        iframe {
            display: none;
        }

        /* Контейнер для центрирования анимации */
        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white; /* Можно настроить под ваш фон */
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function displayUserInfo(data) {
            document.querySelector('.login-button').style.display = 'none';
            const profileDiv = document.querySelector('.profile');
            profileDiv.querySelector('.avatar').style.backgroundImage = 'url(https://avatars.yandex.net/get-yapic/' + data.default_avatar_id + '/islands-middle)';

            // Извлечение фамилии, имени и отчества
             // Извлечение фамилии, имени и отчества
            const names = data.real_name.split(' ');
            let displayName = names[2] + ' ' + names[0][0] + '.';
            if (names.length > 2) {
                displayName += names[1][0] + '.';
            }

            profileDiv.querySelector('.profile-name').textContent = displayName;
            profileDiv.style.display = 'flex';
        }

        window.onload = function() {
            var accessToken = getCookie('access_token');
            if (accessToken) {
                // Попытка получить данные из localStorage
                let cachedData = localStorage.getItem('user_info');
                let cacheTimestamp = localStorage.getItem('cache_timestamp');
                const cacheExpiry = 5 * 60 * 1000; // Кэш действителен 5 минут

                const now = new Date().getTime();

                if (cachedData && cacheTimestamp && (now - cacheTimestamp < cacheExpiry)) {
                    displayUserInfo(JSON.parse(cachedData));
                } else {
                    fetch('/user_info', {
                        headers: {
                            'Authorization': 'OAuth ' + accessToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching user info:', data.error);
                            document.querySelector('.login-button').style.display = 'block';
                            document.querySelector('.profile').style.display = 'none';
                        } else {
                            // Кэширование данных в localStorage
                            localStorage.setItem('user_info', JSON.stringify(data));
                            localStorage.setItem('cache_timestamp', now);
                            displayUserInfo(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user info:', error);
                        document.querySelector('.login-button').style.display = 'block';
                        document.querySelector('.profile').style.display = 'none';
                    });
                }
            } else {
                document.querySelector('.login-button').style.display = 'block';
                document.querySelector('.profile').style.display = 'none';
            }
        }

        function Login() {
            window.location.href = "https://oauth.yandex.ru/authorize?response_type=code&client_id=b18e232b89424dd7ae7b4d65cab1e070";
        }

        function Logout() {
            document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            localStorage.removeItem('user_info');
            localStorage.removeItem('cache_timestamp');
            window.location.reload();
        }

        function iframeLoaded() {
            // Скрываем анимацию и показываем iframe после загрузки SVG
            document.querySelector('.loader-container').style.display = 'none';
            document.getElementById('content-iframe').style.display = 'block';
        }
    </script>
    <!-- Top navigation bar -->
    <header>
        <div class="header-inner clearfix">
        <div class="header-logo">
            <a href="http://localhost:5000/"><img alt="logo" src="/static/logo.png"></a>
        </div>
        <form action="" method="get" class="header-search">
            <div class="search">
            <input type="search" name="search" placeholder="Искать сотрудника, новости, прочее...">
            <button type="submit" class="material-icons"><span class="material-symbols-outlined">search</span></button>
            </div>
        </form>
        <div class="header-menu">
            <ul class="ul-base">
            <li><button class="feedback-button">Обратная связь</button></li>
            <li class="login-button"><a href="#" onclick="Login()">Login</a></li>
            <li><div class="profile" onclick="Logout()"><div class="avatar"></div><span class="profile-name">UserName</span></div></li>
            <li><div class="help-button-bg"><button class="help-button">?</button></div></li>
            </ul>
        </div>
        </div>
    </header>
    <main role="main">
        <nav class="menu">
            <div class="sidebar">
                <ul class="ul-base">
                    <li><a href="#" onclick="loadIndexPage()"><img src="static/menu/main.png" alt="">Главная</a></li>
                    <li><a href="#" onclick="loadIndexPage()"><img src="static/menu/news.png" alt="">Новости</a></li>
                    <li><a href="#" onclick="loadIndexPage()"><img src="static/menu/staff.png" alt="">Сотрудники</a></li>
                    <li><a href="#" onclick="loadStructurePage()"><img src="static/menu/structure.png" alt="">Структура компании</a></li>
                    <li><a href="#" onclick="loadIndexPage()"><img src="static/menu/documents.png" alt="">Документы</a></li>
                    <li><a href="#" onclick="loadIndexPage()"><img src="static/menu/account.png" alt="">Личный кабинет</a></li>
                    <!-- Добавить другие пункты меню при необходимости -->
                </ul>
            </div>
        </nav>

        <div class="iframe-container">
            <div class="loader-container">
                <div class="loader"></div>
            </div>
            <!-- Контейнер для iframe -->
            <iframe id="content-iframe" src="" frameborder="0" onload="iframeLoaded()"></iframe>
        </div>

        <div class="content">
            <div class="banners-slider">
                <div class="itc-slider" data-slider="itc-slider">
                    <div class="itc-slider-wrapper">
                        <div class="itc-slider-items">
                            <div class="itc-slider-item">
                                <img src="static/slide-1.png" alt="">
                                <div class="slide1-text">
                                    Хотите быть в курсе наших разработок и новостей?
                                    <button>
                                        УЗНАТЬ БОЛЬШЕ
                                    </button>
                                </div>
                            </div>
                            <div class="itc-slider-item">
                                <img src="static/slide-1.png" alt="">
                            </div>
                            <div class="itc-slider-item">
                                <img src="static/slide-1.png" alt="">
                            </div>
                        </div>
                    </div>
                    <button class="itc-slider-btn itc-slider-btn-prev"></button>
                    <button class="itc-slider-btn itc-slider-btn-next"></button>
                    <ol class="itc-slider-indicators">
                        <!-- data-slide-to="0" – для перехода к 1 слайду -->
                        <li class="itc-slider-indicator" data-slide-to="0"></li>
                        <!-- data-slide-to="1" – для перехода к 2 слайду -->
                        <li class="itc-slider-indicator" data-slide-to="1"></li>
                        <!-- data-slide-to="2" – для перехода к 3 слайду -->
                        <li class="itc-slider-indicator" data-slide-to="2"></li>
                    </ol>
                </div>
            </div>
            <div class="banners-static">
                <div class="banner1">
                    <h1>Бронирование переговорной</h1>
                    <span>Проверьте наличие свободных переговорных комнат</span>
                    <img src="static/menu/icon-door.png" alt="">
                </div>
                <div class="banner2">
                    <h1>Запрос в техническую поддержку</h1>
                    <span>Ответим на все ваши вопросы</span>
                    <img src="static/menu/icon-support.png" alt="">
                </div>
                <div class="banner3">
                    <h1>Курьер</h1>
                    <span>Быстро оформите заказ на доставку</span>
                    <img src="static/menu/icon-run.png" alt="">
                </div>
            </div>
        </div>
        <footer></footer><!-- @end footer -->
    </main>

    <!-- Scripts -->
    <script>    
        // Функция для загрузки index.html в iframe
        function loadIndexPage() {
            document.getElementById('content-iframe').src = '';
            document.querySelector('.iframe-container').style.display = 'none';
            document.querySelector('.content').style.display = 'flex';
        }
        function loadStructurePage() {
            document.querySelector('.iframe-container').style.display = 'block';
            document.querySelector('.content').style.display = 'none';
            document.getElementById('content-iframe').src = 'index.html';
        }
        loadIndexPage();
    </script>
</body>
</html>
